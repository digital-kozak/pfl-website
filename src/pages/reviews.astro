---
import Layout from '../layouts/Layout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import reviewsData from '../data/reviews.json';

const { totalReviews, reviewsPerPage, totalPages } = reviewsData;

// Calculate stats from actual data for SEO (keep these server-side)
const allReviews = reviewsData.reviews;
const avgRating = (allReviews.reduce((sum, r) => sum + r.rating, 0) / allReviews.length).toFixed(2);

const stats = [
  { value: avgRating, label: "Average Rating" },
  { value: totalReviews.toString(), label: "Reviews" },
  { value: "100%", label: "Would Recommend" }
];
---

<Layout 
  title="Reviews | Pagosa Forest Lodge" 
  description={`Read ${totalReviews}+ guest reviews of Pagosa Forest Lodge. ${avgRating}-star average rating for our luxury mountain cabin near Wolf Creek Ski Resort in Colorado.`}
  breadcrumbs={[{ name: "Reviews", url: "/reviews" }]}
>
  <script>
    // Client-side API pagination
    let currentPage = 1;
    let totalPages = 1;
    let totalReviews = 0;
    
    async function loadReviews(page = 1) {
      const reviewsContainer = document.getElementById('reviews-grid');
      const loadingEl = document.getElementById('reviews-loading');
      const errorEl = document.getElementById('reviews-error');
      const showingText = document.getElementById('showing-text');
      
      // Show loading, hide error
      if (loadingEl) loadingEl.classList.remove('hidden');
      if (errorEl) errorEl.classList.add('hidden');
      if (reviewsContainer) reviewsContainer.classList.add('opacity-50');
      
      try {
        const response = await fetch(`/api/reviews-${page}.json`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        currentPage = data.pagination.page;
        totalPages = data.pagination.totalPages;
        totalReviews = data.pagination.totalReviews;
        
        // Render reviews
        if (reviewsContainer) {
          reviewsContainer.innerHTML = data.reviews.map(review => `
            <div class="review-card bg-white p-8 rounded-lg shadow-sm transition-all duration-300 hover:shadow-md">
              <!-- Stars -->
              <div class="flex text-[#c9a227] mb-4">
                ${[...Array(5)].map((_, i) => `
                  <svg class="w-5 h-5 ${i < review.rating ? '' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                  </svg>
                `).join('')}
              </div>
              
              <!-- Review Text -->
              <p class="text-gray-700 mb-6 leading-relaxed italic">"${review.text.replace(/"/g, '&quot;')}"</p>
              
              <!-- Author -->
              <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-[#c9a227]/10 flex items-center justify-center mr-4">
                  <span class="text-[#c9a227] font-serif text-lg">${review.avatar}</span>
                </div>
                <div>
                  <p class="font-medium text-[#0f1f0a]">${review.name}</p>
                  <p class="text-sm text-gray-500">${review.location} • ${review.date}</p>
                </div>
              </div>
            </div>
          `).join('');
        }
        
        // Update showing text
        if (showingText) {
          showingText.textContent = `Showing ${data.pagination.start}-${data.pagination.end} of ${data.pagination.totalReviews} reviews`;
        }
        
        // Update pagination
        renderPagination();
        
        // Hide loading
        if (loadingEl) loadingEl.classList.add('hidden');
        if (reviewsContainer) reviewsContainer.classList.remove('opacity-50');
        
        // Scroll to top of reviews section
        document.getElementById('reviews-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
      } catch (error) {
        console.error('Error loading reviews:', error);
        if (loadingEl) loadingEl.classList.add('hidden');
        if (errorEl) {
          errorEl.classList.remove('hidden');
          errorEl.textContent = 'Failed to load reviews. Please try again.';
        }
        if (reviewsContainer) reviewsContainer.classList.remove('opacity-50');
      }
    }
    
    function renderPagination() {
      const paginationContainer = document.getElementById('pagination');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      
      if (!paginationContainer || totalPages <= 1) return;
      
      // Update prev/next buttons
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage === totalPages;
      
      // Generate page buttons
      let paginationHTML = '';
      
      // Show max 5 page buttons around current page
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }
      
      // First page + ellipsis if needed
      if (startPage > 1) {
        paginationHTML += createPageButton(1, false);
        if (startPage > 2) paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
      }
      
      // Page buttons
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += createPageButton(i, i === currentPage);
      }
      
      // Last page + ellipsis if needed
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
        paginationHTML += createPageButton(totalPages, false);
      }
      
      paginationContainer.innerHTML = paginationHTML;
      
      // Add click handlers
      paginationContainer.querySelectorAll('.page-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const page = parseInt(btn.dataset.page);
          if (page !== currentPage) {
            loadReviews(page);
          }
        });
      });
    }
    
    function createPageButton(page, isActive) {
      return `
        <button 
          class="page-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-200 ${
            isActive 
              ? 'bg-[#0f1f0a] text-white' 
              : 'bg-white text-[#0f1f0a] hover:bg-[#0f1f0a]/10'
          }"
          data-page="${page}"
        >
          ${page}
        </button>
      `;
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Load first page
      loadReviews(1);
      
      // Previous/Next buttons
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) loadReviews(currentPage - 1);
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages) loadReviews(currentPage + 1);
        });
      }
    });
  </script>

  <!-- Hero -->
  <section class="relative py-32 hero-overlay">
    <div class="absolute inset-0 z-0">
      <img 
        src="/images/reviews-hero.jpg" 
        alt="Mountain valley view from Wolf Creek Pass" 
        class="w-full h-full object-cover"
      />
    </div>
    
    <div class="relative z-10 container-custom text-center text-white">
      <p class="text-sm uppercase tracking-[0.3em] mb-4">Guest Experiences</p>
      <h1 class="font-serif text-5xl md:text-7xl">
        <span class="italic">Reviews</span>
      </h1>
    </div>
  </section>

  <!-- Breadcrumb Navigation -->
  <Breadcrumb items={[{ name: "Reviews", url: "/reviews" }]} />

  <!-- Stats -->
  <section class="py-16 bg-white">
    <div class="container-custom">
      <!-- Badges -->
      <div class="flex flex-wrap justify-center gap-6 mb-12">
        <!-- Guest Favorite Badge -->
        <div class="flex items-center justify-center">
          <img 
            src="/images/airbnb-guest-favorite.jpg" 
            alt="Airbnb Guest Favorite - One of the most loved homes on Airbnb" 
            class="h-28 md:h-32 object-contain rounded-lg shadow-md"
          />
        </div>
        
        <!-- Superhost Badge -->
        <div class="flex items-center justify-center">
          <img 
            src="/images/airbnb-superhost.jpg" 
            alt="Airbnb Superhost" 
            class="h-28 md:h-32 object-contain rounded-lg shadow-md"
          />
        </div>
      </div>
      
      <!-- Stats Grid -->
      <div class="grid grid-cols-3 gap-8 text-center max-w-3xl mx-auto pt-8 border-t border-gray-200">
        {stats.map((stat) => (
          <div>
            <p class="text-4xl md:text-5xl font-serif text-[#c9a227] mb-2">{stat.value}</p>
            <p class="text-sm uppercase tracking-wider text-gray-600">{stat.label}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Reviews Grid -->
  <section id="reviews-section" class="section-padding bg-[#faf9f6]">
    <div class="container-custom">
      <div class="text-center max-w-3xl mx-auto mb-12">
        <p class="text-[#c9a227] text-sm uppercase tracking-[0.2em] mb-4">Testimonials</p>
        <h2 class="font-serif text-4xl md:text-5xl text-[#0f1f0a]">What Guests <span class="italic">Are Saying</span></h2>
        <p id="showing-text" class="text-gray-500 mt-4">Loading reviews...</p>
      </div>

      <!-- Loading State -->
      <div id="reviews-loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-[#c9a227] border-t-transparent"></div>
        <p class="text-gray-500 mt-4">Loading reviews...</p>
      </div>

      <!-- Error State -->
      <div id="reviews-error" class="hidden text-center py-12">
        <p class="text-red-600">Failed to load reviews. Please try again.</p>
        <button onclick="loadReviews(1)" class="mt-4 px-4 py-2 bg-[#c9a227] text-white rounded-lg hover:bg-[#d4b43a] transition-colors">
          Retry
        </button>
      </div>

      <!-- Reviews Grid -->
      <div id="reviews-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
        <!-- Reviews will be loaded here -->
      </div>

      <!-- Pagination -->
      <div class="flex justify-center items-center space-x-2">
        <button 
          id="prev-page"
          class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-[#0f1f0a] border border-gray-200 hover:bg-[#0f1f0a]/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          disabled
        >
          ← Previous
        </button>
        
        <div id="pagination" class="flex space-x-2">
          <!-- Page numbers will be inserted here -->
        </div>
        
        <button 
          id="next-page"
          class="px-4 py-2 rounded-lg text-sm font-medium bg-white text-[#0f1f0a] border border-gray-200 hover:bg-[#0f1f0a]/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          Next →
        </button>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="section-padding bg-[#0f1f0a] text-white">
    <div class="container-custom text-center">
      <p class="text-[#c9a227] text-sm uppercase tracking-[0.3em] mb-4">Ready to Experience It?</p>
      <h2 class="font-serif text-4xl md:text-5xl mb-6">Join Our <span class="italic">Happy Guests</span></h2>
      <p class="text-white/70 max-w-2xl mx-auto mb-8 text-lg">
        Book your stay today and see why {totalReviews}+ guests have given us a {avgRating}-star rating.
      </p>
      <a href="/book" class="btn-primary text-lg">Book Your Stay</a>
    </div>
  </section>
</Layout>